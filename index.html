    <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>baseball-scorecard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š (Dark Mode) --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        /* iOS Safe Area Fix */
        .pb-safe-area { padding-bottom: env(safe-area-inset-bottom); }
        
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .no-select { user-select: none; -webkit-user-select: none; }
        .cursor-pointer { cursor: pointer; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- UI å…ƒä»¶ --- */
        .scoreboard-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            border-radius: 0.75rem; 
            background-color: #1e293b; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #334155; 
        }
        .scoreboard-container::-webkit-scrollbar { display: none; }

        .score-header { background-color: #1e293b; color: #fbbf24; white-space: nowrap; border-bottom: 2px solid #fbbf24; font-weight: 900; letter-spacing: 0.5px; }
        
        .sb-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.875rem; }
        .sb-th { background-color: #0f172a; color: #94a3b8; font-weight: 700; padding: 0.75rem 0.5rem; border-bottom: 1px solid #334155; white-space: nowrap; text-align: center; min-width: 40px; }
        .sb-td { padding: 0.75rem 0.5rem; text-align: center; border-bottom: 1px solid #334155; white-space: nowrap; font-family: 'Roboto Condensed', sans-serif; font-weight: 600; color: #e2e8f0; min-width: 40px; }

        .sticky-corner { position: sticky; left: 0; z-index: 30; background-color: #0f172a; border-right: 2px solid #1e293b; text-align: left; padding-left: 1rem; box-shadow: 4px 0 8px -2px rgba(0,0,0,0.3); }
        .sticky-team-col { position: sticky; left: 0; z-index: 20; background-color: #1e293b; border-right: 2px solid #0f172a; text-align: left; padding-left: 1rem; font-weight: 900; color: #fff; box-shadow: 4px 0 8px -2px rgba(0,0,0,0.3); }
        
        .th-total, .td-total { width: 3rem; min-width: 3rem; position: sticky; z-index: 25; border-left: 1px solid #334155; }
        thead .th-total { z-index: 35; background-color: #1e293b; } 
        .td-total { background-color: #0f172a; font-size: 1.1rem; font-weight: 900; }
        .col-E { right: 0; } .col-H { right: 3rem; } .col-R { right: 6rem; }
        .col-R::before { content: ''; position: absolute; left: -10px; top: 0; bottom: 0; width: 10px; background: linear-gradient(to right, transparent, rgba(0,0,0,0.3)); pointer-events: none; }
        
        .current-inning-header { color: #fbbf24; background-color: #1e293b; border-bottom: 2px solid #fbbf24; }
        .current-inning-cell { background-color: transparent; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-game {
            position: relative; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; font-weight: 900; color: white; letter-spacing: 1px; transition: transform 0.1s, filter 0.1s; cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.3); text-shadow: 1px 1px 0 rgba(0,0,0,0.2); touch-action: manipulation; line-height: 1.2; user-select: none; -webkit-user-select: none; overflow: hidden;
        }
        .btn-game:active { transform: translateY(4px); box-shadow: 0 0px 0 rgba(0,0,0,0.3); }
        .btn-game.pressing { transform: scale(0.95); filter: brightness(1.2); }
        .btn-game:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }
        
        .hint-capsule {
            position: absolute; bottom: 6px; right: 6px; background: rgba(255, 255, 255, 0.2); padding: 2px 7px; border-radius: 20px; font-size: 14px; line-height: 1; color: rgba(255,255,255,0.9); font-weight: 900; pointer-events: none; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-blue { background: linear-gradient(to bottom, #3b82f6, #2563eb); border-bottom: 4px solid #1d4ed8; }
        .btn-red { background: linear-gradient(to bottom, #ef4444, #dc2626); border-bottom: 4px solid #b91c1c; }
        .btn-green { background: linear-gradient(to bottom, #10b981, #059669); border-bottom: 4px solid #047857; }
        .btn-yellow { background: linear-gradient(to bottom, #eab308, #ca8a04); border-bottom: 4px solid #a16207; color: #fff; }
        .btn-gray { background: linear-gradient(to bottom, #64748b, #475569); border-bottom: 4px solid #334155; }

        .tab-button { border: none; transition: all 0.2s; color: #94a3b8; font-weight: 700; background: transparent; border-radius: 0.5rem; padding: 10px 4px; }
        .tab-button:hover { background-color: rgba(51, 65, 85, 0.5); color: #e2e8f0; }
        .tab-button.active { color: #fff; background-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .stats-table th, .stats-table td { white-space: nowrap; padding: 10px 8px; font-size: 14px; }
        .sticky-col-left { position: sticky; left: 0; z-index: 20; background-color: #1e293b; border-right: 1px solid #475569; }
        .sticky-header-left { position: sticky; left: 0; z-index: 30; background-color: #334155; border-right: 1px solid #475569; }

        .vs-card-compact { display: flex; align-items: stretch; background: linear-gradient(to right, #172554 0%, #1e3a8a 35%, #991b1b 65%, #7f1d1d 100%); border-radius: 12px; overflow: hidden; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .vs-side { flex: 1; padding: 0.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .vs-divider { width: 30px; display: flex; align-items: center; justify-content: center; font-style: italic; font-weight: 900; color: rgba(255,255,255,0.4); background: transparent; z-index: 2; border: none; }
        
        .dashboard-panel { background-color: #1e293b; border-radius: 1rem; border: 1px solid #334155; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); overflow: hidden; }
        
        .bso-dot { width: 32px; height: 32px; border-radius: 50%; background-color: #334155; border: 2px solid #475569; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
        .ball-on { background-color: #22c55e; box-shadow: 0 0 12px #22c55e, inset 0 0 4px rgba(255,255,255,0.6); border-color: #16a34a; } 
        .strike-on { background-color: #eab308; box-shadow: 0 0 12px #eab308, inset 0 0 4px rgba(255,255,255,0.6); border-color: #ca8a04; } 
        .out-on { background-color: #ef4444; box-shadow: 0 0 12px #ef4444, inset 0 0 4px rgba(255,255,255,0.6); border-color: #dc2626; } 

        .field-container { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; background: transparent; }
        .dirt-diamond { position: absolute; width: 100px; height: 100px; background-color: #92400e; border: 2px solid rgba(255,255,255,0.1); transform: rotate(45deg); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .infield-grass { position: absolute; width: 72px; height: 72px; background-color: #166534; transform: rotate(45deg); box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }

        .base { 
            position: absolute; width: 32px; height: 32px; background-color: #f8fafc; box-shadow: 2px 2px 4px rgba(0,0,0,0.6); cursor: pointer; z-index: 20; transition: all 0.2s ease-out; transform: translate(-50%, -50%) rotate(45deg); border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .base-text {
            transform: rotate(-45deg); 
            font-weight: 900;
            color: #1e293b;
            font-size: 0px; 
            transition: font-size 0.2s;
            user-select: none;
        }

        .base-occupied { 
            background: #facc15 !important; 
            box-shadow: 0 0 15px #facc15, 0 0 5px #fff; 
            transform: translate(-50%, -50%) rotate(45deg) scale(1.1); 
            z-index: 25; 
            border: 2px solid white; 
        }
        
        .base-occupied .base-text { font-size: 14px; }
        
        #base2 { top: 28px; left: 100px; } 
        #base1 { top: 100px; left: 172px; } 
        #base3 { top: 100px; left: 28px; } 
        
        #base-home { 
            position: absolute; top: 172px; left: 100px; width: 32px; height: 32px; background-color: #f8fafc; transform: translate(-50%, -50%); 
            clip-path: polygon(0 0, 100% 0, 100% 55%, 50% 100%, 0 55%);
            z-index: 20; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }
        
        .pitcher-mound { position: absolute; width: 24px; height: 24px; background-color: #92400e; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); z-index: 5; opacity: 0.9; border: 1px solid rgba(255,255,255,0.2); }

        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        input, select { font-size: 16px !important; background-color: #334155 !important; color: #fff !important; border-color: #475569 !important; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 pb-safe-area">

    <div class="max-w-4xl mx-auto min-h-screen flex flex-col">
        <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
        <div class="sticky top-0 z-50 bg-slate-900 p-2 shadow-sm">
            <div class="bg-slate-800 rounded-xl px-4 py-3 flex justify-center items-center shadow-lg border border-slate-700 relative">
                 <div class="text-sm text-slate-400 font-mono font-bold text-center flex items-center justify-center gap-3">
                    <span id="game-date-display" onclick="window.editGameDate()" class="cursor-pointer hover:text-white hover:underline decoration-blue-500 decoration-2 underline-offset-4 transition-colors">--/--</span> 
                    <span class="text-slate-600">|</span>
                    <span id="game-location-display" onclick="window.editGameLocation()" class="cursor-pointer hover:text-white hover:underline decoration-blue-500 decoration-2 underline-offset-4 transition-colors">--</span>
                </div>
            </div>
        </div>

        <div id="game-page" class="flex-1 flex flex-col p-2 md:p-4">
            <!-- é ç±¤ -->
            <div class="flex bg-slate-800 rounded-xl p-1 mb-3 shadow-lg">
                <button id="tab-game-btn" onclick="window.showTab('game')" class="tab-button active flex-1 text-sm">æ¯”è³½</button>
                <button id="tab-stats-btn" onclick="window.showTab('stats')" class="tab-button flex-1 text-sm">æ•¸æ“š</button>
                <button id="tab-roster-btn" onclick="window.showTab('roster')" class="tab-button flex-1 text-sm">åå–®</button>
                <button id="tab-log-btn" onclick="window.showTab('log')" class="tab-button flex-1 text-sm">å¯¦æ³</button>
            </div>

            <!-- æ¯”åˆ†æ¿ -->
            <div class="scoreboard-container mb-3 relative">
                <table class="sb-table" id="scoreboard-table">
                    <thead><tr><!-- JS Gen --></tr></thead>
                    <tbody id="scorecard-body"><!-- JS Gen --></tbody>
                </table>
            </div>

            <!-- å‹•ç•«å±¤ -->
            <div id="score-animation-container" class="fixed inset-0 pointer-events-none flex items-center justify-center z-[100] hidden"></div>

            <!-- MAIN GAME TAB -->
            <div id="tab-game" class="tab-content flex-1 flex flex-col">
                <div class="vs-card-compact shadow-lg">
                    <div class="vs-side">
                        <span class="text-[10px] text-blue-200 uppercase font-bold tracking-widest mb-1">PITCHER</span>
                        <div id="display-pitcher-name" class="text-lg font-black text-white leading-none mb-1 truncate max-w-[120px]">--</div>
                        <div class="w-full max-w-[80px] h-1.5 bg-slate-900/50 rounded-full overflow-hidden mt-1 shadow-inner border border-white/10">
                            <div id="pitch-count-bar" class="h-full bg-green-400" style="width: 100%"></div>
                        </div>
                        <div class="text-[10px] text-blue-100 mt-1 font-bold">ç”¨çƒæ•¸: <span id="pitch-count-val" class="font-mono text-white">0</span></div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="vs-side">
                        <span class="text-[10px] text-red-200 uppercase font-bold tracking-widest mb-1">BATTER</span>
                        <div id="display-batter-name" class="text-lg font-black text-white leading-none mb-1 truncate max-w-[120px]">--</div>
                        <div class="bg-white/10 px-2 py-0.5 rounded text-[10px] font-mono text-white mt-1 border border-white/10" id="batter-today-stats-full">--</div>
                    </div>
                </div>

                <div class="dashboard-panel mb-3 shadow-lg">
                    <div class="grid grid-cols-2 h-full min-h-[200px]">
                        <div class="border-r border-slate-700 bg-[#0f172a] p-4 flex flex-col items-center justify-center relative">
                            <div class="flex items-center justify-center mb-8">
                                <span id="inning-num-display" class="text-5xl font-black text-white leading-none tracking-tighter tabular-nums drop-shadow-lg">1</span>
                                <div class="flex flex-col ml-2 justify-center h-full">
                                     <span id="inning-arrow-display" class="text-2xl text-yellow-500 drop-shadow-md">â–²</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-4 w-full max-w-[160px]">
                                <div class="flex items-center gap-3"> 
                                    <span class="font-black text-2xl text-green-500 w-6 text-right">B</span>
                                    <div class="flex gap-3"><div id="ball-1" class="bso-dot"></div><div id="ball-2" class="bso-dot"></div><div id="ball-3" class="bso-dot"></div></div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-black text-2xl text-yellow-500 w-6 text-right">S</span>
                                    <div class="flex gap-3"><div id="strike-1" class="bso-dot"></div><div id="strike-2" class="bso-dot"></div></div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-black text-2xl text-red-500 w-6 text-right">O</span>
                                    <div class="flex gap-3"><div id="out-1" class="bso-dot"></div><div id="out-2" class="bso-dot"></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[#0f172a] p-2 flex items-center justify-center relative">
                            <div id="game-over-display" class="absolute inset-0 bg-slate-900/95 z-20 hidden flex flex-col items-center justify-center">
                                <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700 max-w-sm w-full mx-4">
                                    <p class="text-3xl font-black text-yellow-400 mb-4 text-center">GAME OVER</p>
                                    <div id="game-decisions-container" class="bg-slate-900/50 rounded-lg p-3 mb-4 text-sm space-y-2 border border-slate-700"></div>
                                    <button onclick="window.resetGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg transition-colors">é–‹å§‹æ–°æ¯”è³½</button>
                                </div>
                            </div>

                            <div class="field-container">
                                <div class="dirt-diamond"></div>
                                <div class="infield-grass"></div>
                                <div class="pitcher-mound"></div>
                                <div id="base2" class="base" data-long-press="base2B"><span class="base-text" id="text-base-2B"></span></div>
                                <div id="base1" class="base" data-long-press="base1B"><span class="base-text" id="text-base-1B"></span></div>
                                <div id="base3" class="base" data-long-press="base3B"><span class="base-text" id="text-base-3B"></span></div>
                                <div id="base-home"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 px-3 pb-3 pt-12 rounded-t-2xl shadow-2xl border-t border-slate-700 -mx-2 md:mx-0 md:rounded-xl relative">
                    <div class="absolute top-3 right-3 z-10">
                        <button onclick="window.showHelpModal()" class="text-slate-400 hover:text-white text-xs font-bold bg-slate-700/50 px-3 py-1.5 rounded-lg transition-colors shadow-sm border border-slate-600/50">æç¤º</button>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-3 mt-1">
                        <button onclick="window.handleCount('ball')" class="btn-game btn-green py-5 text-2xl font-black">å£çƒ</button>
                        <button onclick="window.handleCount('strike')" class="btn-game btn-yellow py-5 text-2xl font-black">å¥½çƒ</button>
                        <button onclick="window.handleCount('foul')" class="btn-game btn-gray py-5 text-2xl font-black">ç•Œå¤–</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button id="btn-hit" class="btn-game btn-blue py-6 text-4xl font-black" data-long-press="hit">å®‰æ‰“<div class="hint-capsule">+</div></button>
                        <button id="btn-out" class="btn-game btn-red py-6 text-4xl font-black" data-long-press="out">å‡ºå±€<div class="hint-capsule">+</div></button>
                    </div>

                    <div class="grid grid-cols-4 gap-2">
                        <button id="btn-walk" class="btn-game btn-green py-3 text-sm col-span-1 font-bold" data-long-press="walk">ä¿é€<div class="hint-capsule">+</div></button>
                        <button id="btn-special" class="btn-game btn-gray py-3 text-sm col-span-1 font-bold" data-long-press="special">ç‰¹æ®Š<div class="hint-capsule">+</div></button>
                        <button id="btn-undo" onclick="window.undoLastAction()" class="btn-game btn-yellow py-3 text-sm col-span-1 font-bold" disabled>å¾©åŸ</button>
                        <button onclick="window.resetGame()" class="btn-game btn-red py-3 text-sm col-span-1 font-bold">é‡è¨­</button>
                    </div>
                </div>
            </div>

            <!-- STATS TAB -->
            <div id="tab-stats" class="tab-content hidden pb-20">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 shadow-lg">
                     <label class="block text-slate-400 text-xs font-bold mb-1 uppercase tracking-wider">é¸æ“‡éšŠä¼</label>
                    <select id="stats-team-select" onchange="window.switchStatsTeam(this.value)" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-lg font-bold shadow-sm outline-none focus:border-blue-500 transition-colors appearance-none">
                        <option value="visitor">å®¢éšŠ (Visitor)</option>
                        <option value="home">ä¸»éšŠ (Home)</option>
                    </select>
                </div>
                <div class="flex mb-4 bg-slate-800 rounded-lg p-1 border border-slate-700 shadow-sm">
                    <button onclick="window.switchStatsType('batting')" id="stats-type-batting" class="flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all">æ‰“æ“Šæ•¸æ“š</button>
                    <button onclick="window.switchStatsType('pitching')" id="stats-type-pitching" class="flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all">æŠ•çƒæ•¸æ“š</button>
                </div>
                <div id="stats-content-area">
                    <div id="view-visitor-batting" class="stats-view">
                        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 shadow-lg">
                             <div class="bg-slate-700 px-4 py-2 text-sm font-bold text-blue-300 border-b border-slate-600">å®¢éšŠæ‰“æ“Šæ•¸æ“š</div>
                            <div class="overflow-x-auto"><table class="stats-table w-full text-slate-300" id="visitor-batting-table"><thead></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                    <div id="view-visitor-pitching" class="stats-view hidden">
                        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 shadow-lg">
                            <div class="bg-slate-700 px-4 py-2 text-sm font-bold text-blue-300 border-b border-slate-600">å®¢éšŠæŠ•æ‰‹æ•¸æ“š</div>
                            <div class="overflow-x-auto"><table class="stats-table w-full text-slate-300" id="visitor-pitching-table"><thead></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                    <div id="view-home-batting" class="stats-view hidden">
                        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 shadow-lg">
                             <div class="bg-slate-700 px-4 py-2 text-sm font-bold text-blue-300 border-b border-slate-600">ä¸»éšŠæ‰“æ“Šæ•¸æ“š</div>
                            <div class="overflow-x-auto"><table class="stats-table w-full text-slate-300" id="home-batting-table"><thead></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                    <div id="view-home-pitching" class="stats-view hidden">
                        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 shadow-lg">
                            <div class="bg-slate-700 px-4 py-2 text-sm font-bold text-blue-300 border-b border-slate-600">ä¸»éšŠæŠ•æ‰‹æ•¸æ“š</div>
                            <div class="overflow-x-auto"><table class="stats-table w-full text-slate-300" id="home-pitching-table"><thead></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROSTER TAB -->
            <div id="tab-roster" class="tab-content hidden pb-20">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 shadow-lg">
                    <label class="block text-slate-400 text-xs font-bold mb-1 uppercase tracking-wider">é¸æ“‡éšŠä¼</label>
                    <select id="roster-team-select" onchange="window.renderRosterInputs(window.gameState)" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-lg font-bold shadow-sm outline-none focus:border-blue-500 transition-colors appearance-none">
                        <option value="visitor">å®¢éšŠ (Visitor)</option>
                        <option value="home">ä¸»éšŠ (Home)</option>
                    </select>
                    <div id="team-name-input-container" class="mt-2"></div>
                </div>
                <div class="flex mb-4 bg-slate-800 rounded-lg p-1 border border-slate-700 shadow-sm">
                    <button onclick="window.switchRosterTab('batters')" id="subtab-batters" class="flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all">æ‰“è€…åå–®</button>
                    <button onclick="window.switchRosterTab('pitchers')" id="subtab-pitchers" class="flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all">æŠ•æ‰‹åå–®</button>
                </div>
                <div id="roster-editor-container" class="space-y-2"></div>
                <button onclick="window.addRosterRow()" class="w-full mt-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow transition-colors">+ æ–°å¢çƒå“¡</button>
            </div>

            <!-- LOG TAB -->
            <div id="tab-log" class="tab-content hidden h-full">
                <div id="event-log" class="h-[calc(100vh-180px)] overflow-y-auto bg-slate-800 rounded-xl border border-slate-700 p-4 text-sm font-mono text-slate-300 space-y-2"></div>
            </div>
        </div>

        <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-[90] flex flex-col gap-2 pointer-events-none"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'baseball-pro-mobile-v64-final-fixed-v17';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId, unsubscribe;
        let historyStack = []; 
        const MAX_HISTORY = 10;
        
        window.activeRosterTab = 'batters'; 
        window.currentStatsTeam = 'visitor';
        window.currentStatsType = 'batting';

        const initialState = {
            gameDate: new Date().toISOString().split('T')[0], 
            gameLocation: 'æ£’çƒå ´',
            visitorTeamName: 'å®¢éšŠ', homeTeamName: 'ä¸»éšŠ',
            inning: 1, half: 'top',
            score: { visitor: { R: 0, H: 0, E: 0, innings: { 1: 0 } }, home: { R: 0, H: 0, E: 0, innings: {} } },
            inningStartStats: { vR:0, vH:0, vE:0, hR:0, hH:0, hE:0 },
            count: { balls: 0, strikes: 0, outs: 0 },
            runners: { '1B': false, '2B': false, '3B': false },
            runnerNames: { '1B': '', '2B': '', '3B': '' },
            rosters: { 
                visitor: Array(12).fill(null).map((_, i)=> ({ name: i < 9 ? `å®¢éšŠ${i+1}æ£’` : `å®¢éšŠ${i-8}`, number: '', pos: '' })), 
                home: Array(12).fill(null).map((_, i)=> ({ name: i < 9 ? `ä¸»éšŠ${i+1}æ£’` : `ä¸»éšŠ${i-8}`, number: '', pos: '' })) 
            },
            pitchers: { 
                visitor: Array(6).fill(null).map((_, i) => ({ name: `å®¢æŠ•${i + 1}`, number: '' })), 
                home: Array(6).fill(null).map((_, i) => ({ name: `ä¸»æŠ•${i + 1}`, number: '' })) 
            },
            currentBatterIdx: { visitor: 0, home: 0 },
            currentPitcher: { visitor: 'å®¢æŠ•1', home: 'ä¸»æŠ•1' }, 
            playerStats: {}, eventLog: [], pitchCount: 0, gameOver: false, lastUpdateTime: Date.now(),
            gameSnapshots: []
        };
        window.gameState = JSON.parse(JSON.stringify(initialState));

        // --- 2. UTILITY FUNCTIONS ---

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `bg-white/90 backdrop-blur text-slate-900 px-4 py-3 rounded-xl shadow-xl font-bold border-l-4 ${type==='error'?'border-red-500':'border-blue-500'} animate-pop`;
            t.textContent = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 2500);
        }

        function createInputModal(title, initialValue, onConfirm) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-slate-900/90 z-[120] flex items-center justify-center animate-pop p-4';
            div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-sm rounded-2xl border border-slate-600 p-6 shadow-2xl">
                    <h3 class="text-xl font-black text-white mb-4">${title}</h3>
                    <input type="text" id="modal-input-val" value="${initialValue}" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-lg mb-6 focus:border-blue-500 outline-none">
                    <div class="flex gap-3">
                        <button id="btn-modal-cancel" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 font-bold hover:bg-slate-600">å–æ¶ˆ</button>
                        <button id="btn-modal-confirm" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            const inputEl = document.getElementById('modal-input-val');
            setTimeout(() => inputEl.focus(), 100);
            document.getElementById('btn-modal-cancel').onclick = () => div.remove();
            document.getElementById('btn-modal-confirm').onclick = () => { const val = inputEl.value; if (val && val !== initialValue) { onConfirm(val); } div.remove(); };
        }

        function createPlayerSelectModal(title, roster, onSelect) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-slate-900/90 z-[130] flex items-center justify-center animate-pop p-4';
            const validPlayers = roster.filter(p => p.name && p.name.trim() !== '');
            let listHtml = validPlayers.map((p) => {
                const label = p.number ? `<span class="font-mono text-blue-400 w-8 inline-block text-right mr-2">${p.number}</span>${p.name}` : p.name;
                return `<button class="w-full bg-slate-700 hover:bg-slate-600 active:bg-blue-600 text-white p-3 rounded-lg border border-slate-600 mb-2 font-bold text-left flex items-center transition-colors" data-name="${p.name}">
                    ${label}
                </button>`;
            }).join('');
            if (validPlayers.length === 0) { listHtml = `<div class="text-center text-slate-400 py-4">ç„¡å¯ç”¨çƒå“¡ï¼Œè«‹å…ˆè‡³ã€Œåå–®ã€æ–°å¢</div>`; }
            div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-sm rounded-2xl border border-slate-600 p-5 shadow-2xl flex flex-col max-h-[70vh]">
                    <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                        <h3 class="text-xl font-black text-white">${title}</h3>
                        <button id="btn-player-select-close" class="text-slate-400 hover:text-white p-2 text-lg">âœ•</button>
                    </div>
                    <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar space-y-1">${listHtml}</div>
                </div>
            `;
            document.body.appendChild(div);
            div.querySelectorAll('button[data-name]').forEach(btn => { btn.onclick = () => { onSelect(btn.getAttribute('data-name')); div.remove(); }; });
            document.getElementById('btn-player-select-close').onclick = () => div.remove();
        }

        function createConfirmModal(text, onConfirm) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-slate-900/90 z-[120] flex items-center justify-center animate-pop p-4';
            div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-sm rounded-2xl border border-slate-600 p-6 shadow-2xl">
                    <h3 class="text-xl font-black text-white mb-2">ç¢ºèªæ“ä½œ</h3>
                    <p class="text-slate-300 mb-6 text-sm font-bold">${text}</p>
                    <div class="flex gap-3">
                        <button id="btn-confirm-cancel" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 font-bold hover:bg-slate-600">å–æ¶ˆ</button>
                        <button id="btn-confirm-ok" class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 shadow-lg">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            document.getElementById('btn-confirm-cancel').onclick = () => div.remove();
            document.getElementById('btn-confirm-ok').onclick = () => { onConfirm(); div.remove(); };
        }

        function createOptionModal(title, options) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-slate-900/90 z-[100] flex items-end md:items-center justify-center animate-pop';
            let btnsHtml = options.map(opt => 
                `<button class="w-full bg-slate-800 active:bg-slate-700 text-white p-4 rounded-xl border border-slate-600 mb-2 flex items-center justify-between" onclick="window.handleOptionClick('${opt.type}', '${opt.desc}', ${opt.h}, ${opt.e}, ${opt.o}, ${opt.ibb||false}, '${opt.base||''}')">
                    <span class="font-bold text-lg">${opt.label}</span>
                    <span class="text-xs text-slate-400 bg-slate-900 px-2 py-1 rounded">${opt.type}</span>
                </button>`
            ).join('');
            div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-md md:rounded-2xl rounded-t-2xl border-t md:border border-slate-600 p-4 shadow-2xl">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                        <h3 class="text-xl font-black text-white">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-400 p-2">âœ•</button>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto">${btnsHtml}</div>
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-2 py-3 rounded-xl text-slate-400 font-bold bg-slate-900">å–æ¶ˆ</button>
                </div>
            `;
            document.body.appendChild(div);
        }

        function createBaserunningModal(text, onStandard, onExtra) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-slate-900/90 z-[110] flex items-center justify-center animate-pop p-4';
            div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-sm rounded-2xl border border-blue-500/50 p-6 shadow-2xl">
                    <h3 class="text-xl font-black text-white mb-4 text-center">ğŸƒ é€²éšè·‘å£˜åˆ¤å®š</h3>
                    <p class="text-slate-300 text-center mb-6 font-bold text-lg">${text}</p>
                    <div class="space-y-3">
                        <button id="btn-br-standard" class="w-full py-4 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold border border-slate-600">æ¨™æº–æ¨é€²</button>
                        <button id="btn-br-extra" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-black shadow-lg border-b-4 border-blue-800">ç©æ¥µè·‘å£˜ (å¤šé€²ä¸€å£˜)</button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            document.getElementById('btn-br-standard').onclick = () => { onStandard(); div.remove(); };
            document.getElementById('btn-br-extra').onclick = () => { onExtra(); div.remove(); };
        }

        function showHelpModal() {
             const div = document.createElement('div');
             div.className = 'fixed inset-0 bg-slate-900/90 z-[100] flex items-center justify-center animate-pop p-4';
             div.innerHTML = `
                <div class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-600 p-5 shadow-2xl relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-slate-400 hover:text-white">âœ•</button>
                    <h3 class="text-xl font-black text-white mb-4 border-b border-slate-700 pb-2 flex items-center gap-2">
                        <span class="text-blue-400">â„¹ï¸</span> æ“ä½œèªªæ˜
                    </h3>
                    <div class="text-slate-300 text-sm space-y-3 leading-relaxed">
                        <p><strong class="text-white">é•·æŒ‰åŠŸèƒ½ï¼š</strong><br>æŒ‰éˆ•ä¸Šæœ‰ <span class="bg-white/10 px-1 rounded text-xs font-bold border border-white/20">+</span> ç¬¦è™Ÿä»£è¡¨å¯é•·æŒ‰é–‹å•Ÿé€²éšé¸é …ã€‚</p>
                        <p><strong class="text-white">å£˜åŒ…æ“ä½œï¼š</strong><br>çŸ­æŒ‰å£˜åŒ…å¯æ‰‹å‹•ä¿®æ­£ç‹€æ…‹ï¼›<span class="text-yellow-400 font-bold">é•·æŒ‰å£˜åŒ…</span>å¯é¸æ“‡ã€Œç›œå£˜ã€ã€ã€Œç‰½åˆ¶ã€æˆ–ã€Œä»£è·‘ã€ã€‚</p>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-6 py-3 rounded-xl text-white font-bold bg-blue-600 hover:bg-blue-500 shadow-lg transition-colors">æˆ‘çŸ¥é“äº†</button>
                </div>
             `;
             document.body.appendChild(div);
        }

        function editGameDate() { const current = window.gameState.gameDate; createInputModal("ä¿®æ”¹æ¯”è³½æ—¥æœŸ", current, (newVal) => { const s = JSON.parse(JSON.stringify(window.gameState)); s.gameDate = newVal; saveNewState(s, false); }); }
        function editGameLocation() { const current = window.gameState.gameLocation; createInputModal("ä¿®æ”¹æ¯”è³½åœ°é»", current, (newVal) => { const s = JSON.parse(JSON.stringify(window.gameState)); s.gameLocation = newVal; saveNewState(s, false); }); }

        function showTab(t) { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.getElementById(`tab-${t}`).classList.remove('hidden'); 
            document.querySelectorAll('.tab-button').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`tab-${t}-btn`).classList.add('active'); 
            const sb = document.querySelector('.scoreboard-container');
            if(t === 'roster' || t === 'stats') { sb.classList.add('hidden'); } else { sb.classList.remove('hidden'); }
            if(t === 'stats') { updateStatsVisibility(); }
            if(t === 'roster') { renderRosterInputs(window.gameState); }
        }

        function switchStatsTeam(team) { window.currentStatsTeam = team; updateStatsVisibility(); }

        function switchStatsType(type) {
            window.currentStatsType = type; updateStatsVisibility();
            const btnBat = document.getElementById('stats-type-batting'); const btnPit = document.getElementById('stats-type-pitching');
            if(type === 'batting') {
                btnBat.className = "flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all";
                btnPit.className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all";
            } else {
                btnBat.className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all";
                btnPit.className = "flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all";
            }
        }

        function updateStatsVisibility() {
            document.querySelectorAll('.stats-view').forEach(el => el.classList.add('hidden'));
            const targetId = `view-${window.currentStatsTeam}-${window.currentStatsType}`;
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.classList.remove('hidden');
        }

        function switchRosterTab(t) {
            window.activeRosterTab = t;
            const btnBat = document.getElementById('subtab-batters'); const btnPit = document.getElementById('subtab-pitchers');
            if(t === 'batters') {
                btnBat.className = "flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all";
                btnPit.className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all";
            } else {
                btnBat.className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-400 hover:bg-slate-700/50 transition-all";
                btnPit.className = "flex-1 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all";
            }
            renderRosterInputs(window.gameState);
        }

        // --- 3. DATA HELPER FUNCTIONS ---

        function getPlayerNumber(name) {
            if (!window.gameState) return '';
            const allPlayers = [...window.gameState.rosters.visitor, ...window.gameState.rosters.home];
            const p = allPlayers.find(pl => pl.name === name);
            if (p && p.number) return p.number;
            return name ? name.charAt(0) : '';
        }

        function getPlayerStat(state, name) {
            if (!state.playerStats[name]) state.playerStats[name] = { ab:0, r:0, h:0, rbi:0, bb:0, so:0, sb:0, cs:0, hr:0, _2b:0, _3b:0, hbp_b:0, sf:0, totalOuts:0, p_h:0, p_r:0, p_er:0, p_bb:0, p_hbp:0, p_so:0, np:0, strikes:0, balls:0, details: [], hr_allowed: 0 };
            if (!state.playerStats[name].details) state.playerStats[name].details = [];
            return state.playerStats[name];
        }

        function addPitcherOut(state, name, count) { getPlayerStat(state, name).totalOuts += count; }
        function addPitcherCount(state, name, type) { const s = getPlayerStat(state, name); s.np++; if(type==='strike'||type==='foul') s.strikes++; else if(type==='ball') s.balls++; }
        
        function updateBattingStats(s, n, t, rbi=0) { 
            const st=getPlayerStat(s,n); 
            if(['1B','2B','3B','HR'].includes(t)) { st.ab++; st.h++; if(t==='2B') st._2b++; if(t==='3B') st._3b++; if(t==='HR') st.hr++; } 
            if(['GO','FO','LO','PO','DP','FC','E','K','K_SAFE'].includes(t)) st.ab++; 
            if(t==='SF') st.sf++; 
            if(['K','K_SAFE'].includes(t)) st.so++; 
            if(['BB','IBB'].includes(t)) st.bb++; 
            if(t==='HBP') st.hbp_b++; 
            st.rbi+=rbi; 
            
            let detailCode = t;
            if (t === '1B') detailCode = '1B';
            else if (t === '2B') detailCode = '2B';
            else if (t === '3B') detailCode = '3B';
            else if (t === 'HR') detailCode = 'HR';
            else if (t === 'K' || t === 'K_SAFE') detailCode = 'K';
            else if (t === 'BB') detailCode = 'BB';
            else if (t === 'IBB') detailCode = 'IBB';
            else if (t === 'HBP') detailCode = 'HBP';
            else if (t === 'SF') detailCode = 'SF';
            else if (t === 'SAC') detailCode = 'SAC';
            else if (t === 'E') detailCode = 'E';
            else if (t === 'FC') detailCode = 'FC';
            else if (['GO','FO','LO','PO','DP'].includes(t)) detailCode = 'Out';
            
            st.details.push(detailCode);
        }

        function updatePitchingStats(s, n, t, r=0, er=0) { 
            const st=getPlayerStat(s,n); 
            if(['1B','2B','3B','HR'].includes(t)) st.p_h++; 
            if(t === 'HR') { if(!st.hr_allowed) st.hr_allowed=0; st.hr_allowed++; } 
            if(['K','K_SAFE'].includes(t)) st.p_so++; 
            if(['BB','IBB'].includes(t)) st.p_bb++; 
            if(t==='HBP') st.p_hbp++; 
            st.p_r+=r; 
            st.p_er+=er; 
        }

        function generateCommentary(style, type, player, extraDesc) {
            const p = player || '';
            if (['1B'].includes(type)) return `[${p}] æ“Šå‡ºå®‰æ‰“ï¼Œç«™ä¸Šä¸€å£˜ã€‚`;
            if (['2B'].includes(type)) return `[${p}] æ“Šå‡ºäºŒå£˜å®‰æ‰“ï¼`;
            if (['3B'].includes(type)) return `[${p}] ä¸‰å£˜å®‰æ‰“ï¼è·‘è€…æ”»ä½”ä¸‰å£˜ã€‚`;
            if (['HR'].includes(type)) return `[${p}] é€™çƒæ‰“å¾—éå¸¸æ·±é ... å…¨å£˜æ‰“ï¼`;
            if (['K', 'K_SAFE'].includes(type)) return `[${p}] æ®æ£’è½ç©ºï¼Œä¸‰æŒ¯å‡ºå±€ã€‚`;
            if (['BB', 'IBB'].includes(type)) return `[${p}] é¸åˆ°å››å£çƒä¿é€ã€‚`;
            if (['HBP'].includes(type)) return `[${p}] è§¸èº«çƒä¿é€ä¸Šå£˜ã€‚`;
            if (['GO'].includes(type)) return `[${p}] å…§é‡æ»¾åœ°å‡ºå±€ã€‚`;
            if (['FO', 'LO'].includes(type)) return `[${p}] å¤–é‡é£›çƒæ¥æ®ºå‡ºå±€ã€‚`;
            if (['DP'].includes(type)) return `[${p}] æ“Šå‡ºé›™æ®ºæ‰“ï¼Œæ”»å‹¢ç“¦è§£ã€‚`;
            if (['E'].includes(type)) return `å®ˆå‚™ç™¼ç”Ÿå¤±èª¤ï¼Œè·‘è€…ä¸Šå£˜ã€‚`;
            if (['SB'].includes(type)) return `[${p}] ç›œå£˜æˆåŠŸï¼`;
            if (['CS', 'PO'].includes(type)) return `[${p}] è·‘è€…å‡ºå±€ã€‚`;
            if (['WP', 'PB'].includes(type)) return `æš´æŠ•/æ•é€¸ï¼Œè·‘è€…æ¨é€²ã€‚`;
            return `[${p}] ${extraDesc || ''}`;
        }

        // --- 5. UI Renderers (Defined BEFORE use in updateUI) ---

        function renderStatsTables(s) {
            const setHeaderText = (id, text) => {
                const el = document.querySelector(`#${id} .text-blue-300`);
                if(el) el.textContent = text;
            };
            setHeaderText('view-visitor-batting', `${s.visitorTeamName} æ‰“æ“Šæ•¸æ“š`);
            setHeaderText('view-visitor-pitching', `${s.visitorTeamName} æŠ•æ‰‹æ•¸æ“š`);
            setHeaderText('view-home-batting', `${s.homeTeamName} æ‰“æ“Šæ•¸æ“š`);
            setHeaderText('view-home-pitching', `${s.homeTeamName} æŠ•æ‰‹æ•¸æ“š`);

            const row = (p, isP) => {
                const st = getPlayerStat(s, p.name);
                if(isP) {
                    const ip = Math.floor(st.totalOuts/3) + (st.totalOuts%3===0?'.0':'.'+(st.totalOuts%3));
                    const ipVal = st.totalOuts/3;
                    const era = ipVal > 0 ? ((st.p_er * 9) / ipVal).toFixed(2) : '-.--';
                    return `<tr>
                        <td class="sticky-col-left p-2 font-bold text-blue-300 bg-slate-800 border-b border-slate-700">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500 font-mono">${p.number}</span>
                                <span>${p.name}</span>
                            </div>
                        </td>
                        <td class="p-2 border-b border-slate-700 font-mono text-white">${ip}</td>
                        <td class="p-2 border-b border-slate-700 font-mono">${st.p_h}</td>
                        <td class="p-2 border-b border-slate-700 font-mono text-red-400 font-bold">${st.p_r}</td>
                        <td class="p-2 border-b border-slate-700 font-mono text-red-300">${st.p_er}</td>
                        <td class="p-2 border-b border-slate-700 font-mono">${st.p_bb}</td>
                        <td class="p-2 border-b border-slate-700 font-mono">${st.p_so}</td>
                        <td class="p-2 border-b border-slate-700 font-mono text-slate-400">
                           ${(st.p_h && getPlayerStat(s, p.name).hr_allowed) ? getPlayerStat(s, p.name).hr_allowed : 0}
                        </td>
                    </tr>`;
                }
                
                const detailsStr = st.details ? st.details.join(' â€§ ') : '';
                return `<tr>
                    <td class="sticky-col-left p-2 font-bold text-blue-300 bg-slate-800 border-b border-slate-700">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500 font-mono w-4 text-right">${p.pos || '-'}</span>
                            <span class="text-xs text-slate-500 font-mono">${p.number}</span>
                            <span>${p.name}</span>
                        </div>
                    </td>
                    <td class="p-2 border-b border-slate-700 font-mono">${st.ab}</td>
                    <td class="p-2 border-b border-slate-700 font-mono text-yellow-400">${st.r}</td>
                    <td class="p-2 border-b border-slate-700 font-mono text-white font-bold">${st.h}</td>
                    <td class="p-2 border-b border-slate-700 font-mono">${st.rbi}</td>
                    <td class="p-2 border-b border-slate-700 font-mono">${st.bb}</td>
                    <td class="p-2 border-b border-slate-700 font-mono">${st.so}</td>
                    <td class="p-2 border-b border-slate-700 text-xs text-slate-400 whitespace-nowrap overflow-x-auto max-w-[120px] scrollbar-hide">${detailsStr}</td>
                </tr>`;
            };
            
            const headerBat = `<tr>
                <th class="sticky-header-left p-2 text-left bg-slate-700 min-w-[100px]">å§“å</th>
                <th class="p-2 bg-slate-700">AB</th>
                <th class="p-2 bg-slate-700 text-yellow-400">R</th>
                <th class="p-2 bg-slate-700 text-white">H</th>
                <th class="p-2 bg-slate-700">RBI</th>
                <th class="p-2 bg-slate-700">BB</th>
                <th class="p-2 bg-slate-700">K</th>
                <th class="p-2 bg-slate-700 text-left">å…§å®¹</th>
            </tr>`;
            
            const headerPit = `<tr>
                <th class="sticky-header-left p-2 text-left bg-slate-700 min-w-[100px]">å§“å</th>
                <th class="p-2 bg-slate-700">IP</th>
                <th class="p-2 bg-slate-700">H</th>
                <th class="p-2 bg-slate-700 text-red-400">R</th>
                <th class="p-2 bg-slate-700">ER</th>
                <th class="p-2 bg-slate-700">BB</th>
                <th class="p-2 bg-slate-700">K</th>
                <th class="p-2 bg-slate-700">HR</th>
            </tr>`;

            document.querySelector('#visitor-batting-table thead').innerHTML = headerBat;
            document.querySelector('#visitor-batting-table tbody').innerHTML = s.rosters.visitor.map(p=>row(p,false)).join('');
            document.querySelector('#visitor-pitching-table thead').innerHTML = headerPit;
            document.querySelector('#visitor-pitching-table tbody').innerHTML = s.pitchers.visitor.filter(p=>p.name).map(p=>row(p,true)).join('');
            document.querySelector('#home-batting-table thead').innerHTML = headerBat;
            document.querySelector('#home-batting-table tbody').innerHTML = s.rosters.home.map(p=>row(p,false)).join('');
            document.querySelector('#home-pitching-table thead').innerHTML = headerPit;
            document.querySelector('#home-pitching-table tbody').innerHTML = s.pitchers.home.filter(p=>p.name).map(p=>row(p,true)).join('');
        }

        function renderRosterInputs(s) {
            const container = document.getElementById('roster-editor-container');
            const activeEl = document.activeElement;
            if (container && container.contains(activeEl)) return; 
            const type = document.getElementById('roster-team-select').value;
            const tName = type === 'visitor' ? s.visitorTeamName : s.homeTeamName;
            document.getElementById('team-name-input-container').innerHTML = `<input type="text" value="${tName}" onchange="window.updateTeamName('${type}', this.value)" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-lg shadow-sm outline-none focus:border-blue-500 transition-colors text-white">`;
            let html = '';
            if (window.activeRosterTab === 'batters') {
                s.rosters[type].forEach((p, i) => {
                    html += `<div class="flex gap-2 items-center mb-2">
                        <span class="w-6 text-slate-400 text-xs text-right font-mono">${i+1}.</span>
                        <input type="tel" placeholder="#" value="${p.number||''}" onchange="window.updateRosterPlayer('${type}', ${i}, 'number', this.value)" class="w-12 bg-slate-700 border border-slate-600 rounded p-2 text-center text-white">
                        <input type="text" value="${p.name}" onchange="window.updateRosterPlayer('${type}', ${i}, 'name', this.value)" class="flex-1 bg-slate-700 border border-slate-600 rounded p-2 text-white">
                        <select onchange="window.updateRosterPlayer('${type}', ${i}, 'pos', this.value)" class="w-16 bg-slate-700 border border-slate-600 rounded p-2 text-white">
                            <option value="">-</option>${['P','C','1B','2B','3B','SS','LF','CF','RF','DH'].map(pos=>`<option value="${pos}" ${p.pos===pos?'selected':''}>${pos}</option>`).join('')}
                        </select>
                    </div>`;
                });
            } else {
                 s.pitchers[type].forEach((p, i) => {
                    html += `<div class="flex gap-2 items-center mb-2">
                        <span class="w-6 text-slate-400 text-xs text-right font-mono">P${i+1}</span>
                        <input type="tel" placeholder="#" value="${p.number||''}" onchange="window.updateRosterPitcher('${type}', ${i}, 'number', this.value)" class="w-12 bg-slate-700 border border-slate-600 rounded p-2 text-center text-white">
                        <input type="text" value="${p.name}" onchange="window.updateRosterPitcher('${type}', ${i}, 'name', this.value)" class="flex-1 bg-slate-700 border border-slate-600 rounded p-2 text-white">
                    </div>`;
                });
            }
            if(container) container.innerHTML = html;
        }

        // --- 6. Game Logic Helpers ---

        function handleSmartBaseClearing(s, type) {
            const r1 = s.runners['1B'];
            const r2 = s.runners['2B'];
            const r3 = s.runners['3B'];

            if (type === 'DP') {
                if (r1 && r2 && r3) {
                    if (s.count.outs <= 1) { s.runners['1B'] = false; s.runnerNames['1B'] = ''; }
                } else if (r1) {
                    s.runners['1B'] = false; s.runnerNames['1B'] = '';
                    if (r2) { s.runners['3B'] = true; s.runnerNames['3B'] = s.runnerNames['2B']; s.runners['2B'] = false; s.runnerNames['2B'] = ''; } 
                }
            } 
            else if (type === 'FC') {
                let runnerOut = false;
                if (r3) { s.runners['3B'] = false; s.runnerNames['3B'] = ''; runnerOut = true; } 
                else if (r2) { s.runners['2B'] = false; s.runnerNames['2B'] = ''; runnerOut = true; } 
                else if (r1) { s.runners['1B'] = false; s.runnerNames['1B'] = ''; runnerOut = true; } 
                const team = s.half==='top'?'visitor':'home'; 
                const bName = s.rosters[team][s.currentBatterIdx[team]].name;
                s.runners['1B'] = true; s.runnerNames['1B'] = bName;
            }
        }

        function addSnapshot(s, type) {
            if (!s.gameSnapshots) s.gameSnapshots = [];
            s.gameSnapshots.push({
                type: type,
                inning: s.inning,
                half: s.half,
                vScore: s.score.visitor.R,
                hScore: s.score.home.R,
                vPitcher: s.currentPitcher.visitor,
                hPitcher: s.currentPitcher.home
            });
        }

        function calculateDecisions(s) {
            if (s.score.visitor.R === s.score.home.R) return "å¹³æ‰‹ (ç„¡å‹æ•—)";
            const winningTeam = s.score.visitor.R > s.score.home.R ? 'visitor' : 'home';
            const losingTeam = winningTeam === 'visitor' ? 'home' : 'visitor';
            let winPitcher = null; let losePitcher = null; let savePitcher = null;
            let winnerTookLeadIndex = -1;
            let currentLeader = 'tied';
            const fullSnaps = [{vScore: 0, hScore: 0, vPitcher: s.pitchers.visitor[0].name, hPitcher: s.pitchers.home[0].name}, ...s.gameSnapshots];

            for(let i=1; i<fullSnaps.length; i++) {
                const snap = fullSnaps[i];
                let leaderNow = 'tied';
                if (snap.vScore > snap.hScore) leaderNow = 'visitor';
                if (snap.hScore > snap.vScore) leaderNow = 'home';
                if (leaderNow === winningTeam && currentLeader !== winningTeam) { winnerTookLeadIndex = i; }
                if (leaderNow !== winningTeam && leaderNow !== 'tied') { winnerTookLeadIndex = -1; }
                currentLeader = leaderNow;
            }
            if (winnerTookLeadIndex !== -1) {
                const winSnap = fullSnaps[winnerTookLeadIndex];
                winPitcher = winningTeam === 'visitor' ? winSnap.vPitcher : winSnap.hPitcher;
                losePitcher = losingTeam === 'visitor' ? winSnap.vPitcher : winSnap.hPitcher;
                const starterName = s.pitchers[winningTeam][0].name;
                if (winPitcher === starterName) {
                    const stats = getPlayerStat(s, winPitcher);
                    if (stats.totalOuts < 15) { 
                        for (let k=winnerTookLeadIndex+1; k<fullSnaps.length; k++) {
                            const nextP = winningTeam === 'visitor' ? fullSnaps[k].vPitcher : fullSnaps[k].hPitcher;
                            if (nextP !== starterName) { winPitcher = nextP; break; }
                        }
                    }
                }
            }
            const lastSnap = fullSnaps[fullSnaps.length-1];
            const closer = winningTeam === 'visitor' ? lastSnap.vPitcher : lastSnap.hPitcher;
            if (closer !== winPitcher) {
                const scoreDiff = Math.abs(s.score.visitor.R - s.score.home.R);
                const closerStats = getPlayerStat(s, closer);
                if (scoreDiff <= 3 || closerStats.totalOuts >= 9) { savePitcher = closer; }
            }
            return `<div class="grid grid-cols-2 gap-2 text-left"><div class="text-slate-400">å‹æŠ• (W)</div><div class="font-bold text-white">${winPitcher || '--'}</div><div class="text-slate-400">æ•—æŠ• (L)</div><div class="font-bold text-white">${losePitcher || '--'}</div><div class="text-slate-400">æ•‘æ´ (S)</div><div class="font-bold text-white">${savePitcher || '--'}</div></div>`;
        }

        function advanceRunners(s, bases, extraBaseMap = {}) {
            let runs=0; let runners=[]; ['1B','2B','3B'].forEach(k=>{if(s.runners[k]) runners.push({b:parseInt(k[0]),n:s.runnerNames[k], startB: k})});
            const team = s.half==='top'?'visitor':'home'; const bName = s.rosters[team][s.currentBatterIdx[team]].name; runners.push({b:0,n:bName});
            s.runners={'1B':false,'2B':false,'3B':false}; let newR={};
            runners.sort((a,b)=>b.b-a.b).forEach(r=>{
                let extra = 0; if (r.startB && extraBaseMap[r.startB]) extra = extraBaseMap[r.startB];
                let dest = r.b + bases + extra;
                if(dest>=4) { runs++; getPlayerStat(s,r.n).r++; updatePitchingStats(s, s.currentPitcher[s.half==='top'?'home':'visitor'], 'RUN', 1, 1); }
                else { newR[dest]=r.n; }
            });
            Object.keys(newR).forEach(b=>{ const k=b+'B'; s.runners[k]=true; s.runnerNames[k]=newR[b]; });
            return {runs:runs};
        }

        function advanceRunnersWalk(s) {
            let runs = 0;
            const r1 = s.runners['1B'];
            const r2 = s.runners['2B'];
            const r3 = s.runners['3B'];
            const n1 = s.runnerNames['1B'];
            const n2 = s.runnerNames['2B'];
            const n3 = s.runnerNames['3B'];
            
            const team = s.half === 'top' ? 'visitor' : 'home'; 
            const bName = s.rosters[team][s.currentBatterIdx[team]].name;
            const pName = s.currentPitcher[s.half==='top'?'home':'visitor'];

            s.runners['1B'] = true;
            s.runnerNames['1B'] = bName;

            if (r1) {
                s.runners['2B'] = true;
                s.runnerNames['2B'] = n1;
                if (r2) {
                    s.runners['3B'] = true;
                    s.runnerNames['3B'] = n2;
                    if (r3) {
                        runs++;
                        getPlayerStat(s, n3).r++;
                        updatePitchingStats(s, pName, 'RUN', 1, 1);
                    }
                } else {
                    if (r3) {
                        s.runners['3B'] = true;
                        s.runnerNames['3B'] = n3;
                    }
                }
            } else {
                if (r2) {
                    s.runners['2B'] = true;
                    s.runnerNames['2B'] = n2;
                }
                if (r3) {
                    s.runners['3B'] = true;
                    s.runnerNames['3B'] = n3;
                }
            }
            return { runs: runs };
        }

        function triggerScoreAnim(runs) {
            const el = document.getElementById('score-animation-container');
            el.innerHTML = `<div class="text-6xl font-black text-yellow-400 drop-shadow-lg scale-150 animate-pop">å¾—åˆ† +${runs}</div>`;
            el.classList.remove('hidden');
            setTimeout(() => { el.classList.add('hidden'); el.innerHTML = ''; }, 2000);
        }

        function pushHistory() {
            if (!window.gameState) return;
            if (historyStack.length >= MAX_HISTORY) historyStack.shift();
            historyStack.push(JSON.stringify(window.gameState));
            updateUndoButton();
        }

        function undoLastAction() {
            if (historyStack.length === 0) { showToast('ç„¡å¯å¾©åŸçš„å‹•ä½œ', 'error'); return; }
            const prev = JSON.parse(historyStack.pop());
            saveNewState(prev, false); 
            showToast('å·²å¾©åŸä¸Šä¸€æ­¥', 'normal');
            updateUndoButton();
        }

        function updateUndoButton() {
            const btn = document.getElementById('btn-undo');
            if(btn) { btn.disabled = historyStack.length === 0; btn.style.opacity = historyStack.length === 0 ? '0.5' : '1'; }
        }

        // --- 7. Main Game Action Handlers ---

        function handleNextBatter(s) { 
            const t = s.half === 'top' ? 'visitor' : 'home'; 
            s.currentBatterIdx[t] = (s.currentBatterIdx[t] + 1) % 9; 
        }

        function nextHalfInning() {
             let s = JSON.parse(JSON.stringify(window.gameState));
             addSnapshot(s, 'inning_end');
             if (s.inning >= 9 && s.half === 'bottom' && s.score.home.R > s.score.visitor.R) { s.gameOver = true; saveNewState(s); return; }
             if (s.half === 'top') { s.half = 'bottom'; } else { s.half = 'top'; s.inning++; }
             const team = s.half === 'top' ? 'visitor' : 'home';
             if (s.score[team].innings[s.inning] === undefined) { s.score[team].innings[s.inning] = 0; }
             s.count = { balls: 0, strikes: 0, outs: 0 }; 
             s.runners = { '1B': false, '2B': false, '3B': false }; s.runnerNames = { '1B': '', '2B': '', '3B': '' };
             s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: `--- ç¬¬${s.inning}å±€${s.half==='top'?'ä¸Š':'ä¸‹'} ---`});
             saveNewState(s);
        }

        function handlePlayLogic(s, type, desc, h, e, o, ibb, extraBaseMap = {}) {
            const team = s.half==='top'?'visitor':'home'; const pTeam = s.half==='top'?'home':'visitor';
            const bName = s.rosters[team][s.currentBatterIdx[team]].name; const pName = s.currentPitcher[pTeam];
            
            // Fix: IBB does not count as pitch
            if(!['K','K_SAFE','BB','IBB','HBP','FC','DP','SAC','SF','GO','FO','LO','PO'].includes(type) && type !== 'E') { 
                s.pitchCount++; addPitcherCount(s,pName,'strike'); 
            }
            
            let r=0; 
            
            if (type === 'K_SAFE') {
                updatePitchingStats(s, pName, 'K', 0, 0);
                const st = getPlayerStat(s, bName); st.ab++; st.so++; st.details.push('K(PB/WP)');
                const res = advanceRunners(s, 1); r = res.runs;
            }
            else if (type === 'DP') {
                handleSmartBaseClearing(s, 'DP');
                updateBattingStats(s, bName, 'DP', 0); updatePitchingStats(s, pName, 'DP', 0, 0);
            }
            else if (type === 'FC') {
                handleSmartBaseClearing(s, 'FC');
                updateBattingStats(s, bName, 'FC', 0); updatePitchingStats(s, pName, 'FC', 0, 0);
            }
            else {
                let bases=0; 
                if(type==='HR') bases=4; 
                else if(type==='3B') bases=3; 
                else if(type==='2B') bases=2; 
                else if(['1B','K_SAFE'].includes(type)) bases=1; 
                
                if (['BB','IBB','HBP'].includes(type)) {
                     r = advanceRunnersWalk(s).runs;
                } else if(bases>0) { 
                    r = advanceRunners(s, bases, extraBaseMap).runs; 
                }
                else if(type==='SF') { 
                    if (desc.includes('å¾—åˆ†') && s.runners['3B']) {
                        r=1; s.runners['3B']=false; getPlayerStat(s,s.runnerNames['3B']).r++; updatePitchingStats(s,pName,'SF',1,1);
                    } 
                }
                else if(type==='SAC') { 
                    if(s.runners['3B']){r++;s.runners['3B']=false;} 
                    if(s.runners['2B']){s.runners['3B']=true;s.runners['2B']=false;} 
                    if(s.runners['1B']){s.runners['2B']=true;s.runners['1B']=false;} 
                }
                
                if (type !== 'K_SAFE') { 
                    updateBattingStats(s, bName, type, r); 
                    updatePitchingStats(s, pName, type, r, (type==='E'?0:r));
                }
            }
            
            if(r>0) { 
                s.score[team].R += r; 
                s.score[team].innings[s.inning] = (s.score[team].innings[s.inning]||0) + r; 
                triggerScoreAnim(r); 
                addSnapshot(s, 'score'); 
            }

            if (s.inning >= 9 && s.half === 'bottom' && s.score.home.R > s.score.visitor.R) {
                s.gameOver = true;
                s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: `ğŸ”¥ å†è¦‹æ¯”è³½ï¼ä¸»éšŠç²å‹ï¼`});
            }
            
            if(h>0) s.score[team].H += h; if(e>0) s.score[team].E += e;
            
            s.count.balls=0; s.count.strikes=0;
            if(o>0) { s.count.outs+=o; addPitcherOut(s, pName, o); }
            
            let logText = generateCommentary('default', type, bName, desc);
            s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: logText});
            
            if (s.gameOver) {
                saveNewState(s);
            } else if(s.count.outs>=3) {
                handleNextBatter(s);
                saveNewState(s);
                setTimeout(()=>nextHalfInning(), 600); 
            } else {
                handleNextBatter(s);
                saveNewState(s);
            }
        }

        function handlePlay(t, desc, h, e, o, ibb) {
            if (t === 'SF' && desc === 'çŠ§ç‰²é£›çƒ (ç¢ºèª)') {
                createOptionModal('çŠ§ç‰²é£›çƒçµæœ', [
                    {label: 'å¾—åˆ† (ä¸‰å£˜å›å£˜)', type: 'SF_SCORE', desc: 'çŠ§ç‰²é£›çƒ (å¾—åˆ†)', h:0, e:0, o:1},
                    {label: 'åƒ…æ¨é€² (ç„¡å¾—åˆ†)', type: 'SF_ADVANCE', desc: 'çŠ§ç‰²é£›çƒ (ç„¡å¾—åˆ†)', h:0, e:0, o:1},
                    {label: 'å–æ¶ˆ (æ”¹ç‚ºæ¥æ®º)', type: 'FO', desc: 'é«˜é£›æ¥æ®º', h:0, e:0, o:1}
                ]);
                return;
            }
            const s = window.gameState;
            if (t === '1B' && s.runners['2B']) {
                createBaserunningModal("äºŒå£˜è·‘è€…å‹•å‘ï¼Ÿ", () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc, h, e, o, ibb), () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc + "(ç©æ¥µè·‘å£˜)", h, e, o, ibb, {'2B': 1}));
                return;
            }
             if (t === '1B' && s.runners['1B'] && !s.runners['2B'] && !s.runners['3B']) {
                createBaserunningModal("ä¸€å£˜è·‘è€…å‹•å‘ï¼Ÿ", () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc, h, e, o, ibb), () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc + "(ç©æ¥µè·‘å£˜)", h, e, o, ibb, {'1B': 1}));
                return;
            }
            if (t === '2B' && s.runners['1B']) {
                 createBaserunningModal("ä¸€å£˜è·‘è€…å‹•å‘ï¼Ÿ", () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc, h, e, o, ibb), () => handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc + "(ç©æ¥µè·‘å£˜)", h, e, o, ibb, {'1B': 1}));
                return;
            }
            handlePlayLogic(JSON.parse(JSON.stringify(s)), t, desc, h, e, o, ibb);
        }

        function handleOptionClick(t, d, h, e, o, ibb, base) {
            if (t === 'SF_SCORE') { handlePlay('SF', 'çŠ§ç‰²é£›çƒ (å¾—åˆ†)', 0, 0, 1, false); }
            else if (t === 'SF_ADVANCE') { handlePlay('SF', 'çŠ§ç‰²é£›çƒ (ç„¡å¾—åˆ†)', 0, 0, 1, false); } 
            else if (t === 'RUNNER_SCORE') handleRunnerScored();
            else if (['SB', 'CS', 'PO', 'PR', 'CLEAR'].includes(t)) { handleBaseAction(t, base); }
            else if (['WP', 'PB', 'BALK'].includes(t)) { if(t==='BALK') handleBalk(); else handlePitchEvent(t); } 
            else handlePlay(t, d, h, e, o, ibb);
            const modal = document.querySelector('.fixed.inset-0.bg-slate-900\\/90');
            if(modal) modal.remove();
        }

        function showBaseOptions(base) {
            if (!window.gameState.runners[base]) { showToast("è©²å£˜åŒ…ç„¡è·‘è€…", "error"); return; }
            createOptionModal(`å£˜åŒ…å‹•ä½œ (${base})`, [
                {label: 'ç›œå£˜æˆåŠŸ (SB)', type: 'SB', desc: 'ç›œå£˜æˆåŠŸ', h:0, e:0, o:0, base: base},
                {label: 'ç›œå£˜å¤±æ•— (CS)', type: 'CS', desc: 'ç›œå£˜å¤±æ•—', h:0, e:0, o:1, base: base},
                {label: 'ç‰½åˆ¶å‡ºå±€ (PO)', type: 'PO', desc: 'ç‰½åˆ¶å‡ºå±€', h:0, e:0, o:1, base: base},
                {label: 'æ›´æ›ä»£è·‘ (PR)', type: 'PR', desc: 'æ›´æ›ä»£è·‘', h:0, e:0, o:0, base: base},
                {label: 'æ¸…ç©ºå£˜åŒ… (ä¿®æ­£)', type: 'CLEAR', desc: 'ä¿®æ­£', h:0, e:0, o:0, base: base}
            ]);
        }

        function handleBaseAction(action, base) {
            let s = JSON.parse(JSON.stringify(window.gameState));
            const runnerName = s.runnerNames[base];
            
            if (action === 'SB') {
                const nextBaseMap = {'1B':'2B', '2B':'3B', '3B':'Home'};
                const next = nextBaseMap[base];
                if (next === 'Home') { 
                    s.runners[base] = false; s.score[s.half==='top'?'visitor':'home'].R++;
                    triggerScoreAnim(1); addSnapshot(s, 'score'); getPlayerStat(s, runnerName).sb++;
                } else {
                    if (s.runners[next]) { showToast('å‰ä½å£˜åŒ…æœ‰äººï¼Œç„¡æ³•ç›œå£˜', 'error'); return; }
                    s.runners[base] = false; s.runners[next] = true; s.runnerNames[next] = runnerName;
                    getPlayerStat(s, runnerName).sb++;
                }
                const txt = generateCommentary('default', 'SB', runnerName, `ç›œå£˜æˆåŠŸ (${base}->${next})`);
                s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: txt});
            } else if (action === 'CS' || action === 'PO') {
                s.runners[base] = false; s.count.outs++;
                addPitcherOut(s, s.currentPitcher[s.half==='top'?'home':'visitor'], 1);
                if (action === 'CS') getPlayerStat(s, runnerName).cs++;
                const txt = generateCommentary('default', action, runnerName, action==='CS'?'ç›œå£˜å¤±æ•—':'ç‰½åˆ¶å‡ºå±€');
                s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: txt});
                if (s.count.outs >= 3) { setTimeout(() => nextHalfInning(), 600); }
            } else if (action === 'PR') {
                const team = s.half === 'top' ? 'visitor' : 'home';
                const roster = s.rosters[team];
                createPlayerSelectModal("é¸æ“‡ä»£è·‘çƒå“¡", roster, (newName) => {
                     let newState = JSON.parse(JSON.stringify(window.gameState));
                     newState.runnerNames[base] = newName;
                     newState.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: `æ›´æ›ä»£è·‘: ${runnerName} -> ${newName}`});
                     saveNewState(newState);
                });
                return; 
            } else if (action === 'CLEAR') {
                s.runners[base] = false;
                s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: `[ä¿®æ­£] æ¸…ç©º ${base}`});
            }
            saveNewState(s);
        }
        
        function changeRunnerName(base, newName) { const s = JSON.parse(JSON.stringify(window.gameState)); s.runnerNames[base] = newName; saveNewState(s); }

        function showHitOptions() {
            createOptionModal('å®‰æ‰“é¡å‹', [
                {label: 'ä¸€å£˜å®‰æ‰“', type: '1B', desc: 'ä¸€å£˜å®‰æ‰“', h: 1, e: 0, o: 0},
                {label: 'äºŒå£˜å®‰æ‰“', type: '2B', desc: 'äºŒå£˜å®‰æ‰“', h: 1, e: 0, o: 0},
                {label: 'ä¸‰å£˜å®‰æ‰“', type: '3B', desc: 'ä¸‰å£˜å®‰æ‰“', h: 1, e: 0, o: 0},
                {label: 'å…¨å£˜æ‰“', type: 'HR', desc: 'å…¨å£˜æ‰“', h: 1, e: 0, o: 0}
            ]);
        }
        function showOutOptions() {
            createOptionModal('å‡ºå±€æ–¹å¼', [
                {label: 'æ»¾åœ°å‡ºå±€', type: 'GO', desc: 'æ»¾åœ°å‡ºå±€', h: 0, e: 0, o: 1},
                {label: 'é«˜é£›æ¥æ®º', type: 'FO', desc: 'é«˜é£›æ¥æ®º', h: 0, e: 0, o: 1},
                {label: 'å¹³é£›æ¥æ®º', type: 'LO', desc: 'å¹³é£›æ¥æ®º', h: 0, e: 0, o: 1},
                {label: 'å…§é‡é«˜é£›', type: 'PO', desc: 'å…§é‡é«˜é£›', h: 0, e: 0, o: 1},
                {label: 'é›™æ®ºæ‰“', type: 'DP', desc: 'é›™æ®ºæ‰“', h: 0, e: 0, o: 2},
                {label: 'é‡æ‰‹é¸æ“‡', type: 'FC', desc: 'é‡æ‰‹é¸æ“‡', h: 0, e: 0, o: 1},
                {label: 'çŠ§ç‰²é£›çƒ', type: 'SF', desc: 'çŠ§ç‰²é£›çƒ (ç¢ºèª)', h: 0, e: 0, o: 1},
                {label: 'çŠ§ç‰²è§¸æ“Š', type: 'SAC', desc: 'çŠ§ç‰²è§¸æ“Š', h: 0, e: 0, o: 1},
                {label: 'ä¸æ­»ä¸‰æŒ¯ (ä¸Šå£˜)', type: 'K_SAFE', desc: 'ä¸æ­»ä¸‰æŒ¯ (ä¸Šå£˜)', h: 0, e: 0, o: 0}
            ]);
        }
        function showWalkOptions() {
            createOptionModal('ä¿é€æ–¹å¼', [
                {label: 'å››å£çƒ', type: 'BB', desc: 'å››å£çƒ', h: 0, e: 0, o: 0},
                {label: 'æ•…æ„å››å£', type: 'IBB', desc: 'æ•…æ„å››å£', h: 0, e: 0, o: 0, ibb: true},
                {label: 'è§¸èº«çƒ', type: 'HBP', desc: 'è§¸èº«çƒ', h: 0, e: 0, o: 0}
            ]);
        }
        function showSpecialOptions() {
            createOptionModal('ç‰¹æ®Šç´€éŒ„', [
                {label: 'å®ˆå‚™å¤±èª¤', type: 'E', desc: 'å®ˆå‚™å¤±èª¤', h: 0, e: 1, o: 0},
                {label: 'æš´æŠ•', type: 'WP', desc: 'æš´æŠ•', h: 0, e: 0, o: 0},
                {label: 'æ•é€¸', type: 'PB', desc: 'æ•é€¸', h: 0, e: 0, o: 0},
                {label: 'æŠ•æ‰‹çŠ¯è¦', type: 'BALK', desc: 'æŠ•æ‰‹çŠ¯è¦', h: 0, e: 0, o: 0},
                {label: 'ä¸‰å£˜è·‘å›', type: 'RUNNER_SCORE', desc: 'ä¸‰å£˜è·‘å›', h: 0, e: 0, o: 0}
            ]);
        }

        async function saveNewState(ns, pushToHistory = true) { 
            if (pushToHistory && window.gameState) pushHistory();
            window.gameState = ns; updateUI(ns); 
            if(db && userId) await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/baseball_scorecards_pro/game_state`), {...ns, lastUpdateTime: Date.now()}); 
        }

        function updateTeamName(t,v) { let s=JSON.parse(JSON.stringify(window.gameState)); if(t==='visitor') s.visitorTeamName=v; else s.homeTeamName=v; saveNewState(s, false); }

        // Fix: Migrate stats and update current runner/pitcher references when renaming
        function updateRosterPlayer(t,i,f,v) { 
            let s=JSON.parse(JSON.stringify(window.gameState)); 
            if (!s.rosters[t][i]) s.rosters[t][i] = { name: '', number: '', pos: '' }; 
            
            if (f === 'name') {
                const oldName = s.rosters[t][i].name;
                // Migrate stats
                if (oldName && oldName !== v && s.playerStats[oldName]) {
                    s.playerStats[v] = s.playerStats[oldName];
                    delete s.playerStats[oldName];
                }
                // Update runners if on base
                ['1B', '2B', '3B'].forEach(base => {
                    if (s.runnerNames[base] === oldName) s.runnerNames[base] = v;
                });
            }
            
            s.rosters[t][i][f]=v; 
            saveNewState(s, false); 
        }

        function updateRosterPitcher(t,i,f,v) { 
            let s=JSON.parse(JSON.stringify(window.gameState)); 
            if (!s.pitchers[t][i]) s.pitchers[t][i] = { name: '', number: '' }; 
            
            if (f === 'name') {
                const oldName = s.pitchers[t][i].name;
                // Migrate stats
                if (oldName && oldName !== v && s.playerStats[oldName]) {
                    s.playerStats[v] = s.playerStats[oldName];
                    delete s.playerStats[oldName];
                }
                // Update current pitcher if active
                const defaultNameOld = t === 'visitor' ? 'å®¢éšŠå…ˆç™¼' : 'ä¸»éšŠå…ˆç™¼';
                const defaultNameNew = t === 'visitor' ? 'å®¢æŠ•1' : 'ä¸»æŠ•1';
                if (s.currentPitcher[t] === oldName || 
                   ((s.currentPitcher[t] === defaultNameOld || s.currentPitcher[t] === defaultNameNew) && i === 0)) {
                    s.currentPitcher[t] = v;
                }
            }

            s.pitchers[t][i][f]=v; 
            saveNewState(s, false); 
        }
        
        function setActivePitcher(t,n) { 
            let s=JSON.parse(JSON.stringify(window.gameState)); 
            if(n) { 
                s.currentPitcher[t]=n; 
                const txt = generateCommentary('default', 'PITCHER_CHANGE', n, `æ›´æ›æŠ•æ‰‹: ${n}`);
                s.eventLog.push({time:'--', text: txt}); 
                addSnapshot(s, 'pitcher_change'); 
                saveNewState(s); 
            }
        }
        
        function handleBaseClick(b) { let s=JSON.parse(JSON.stringify(window.gameState)); s.runners[b] = !s.runners[b]; if(s.runners[b]) s.runnerNames[b] = "è·‘è€…"; saveNewState(s); }
        
        function handleRunnerScored() { 
            let s=JSON.parse(JSON.stringify(window.gameState)); 
            if(s.runners['3B']) { 
                s.runners['3B']=false; s.score[s.half==='top'?'visitor':'home'].R++; 
                triggerScoreAnim(1); 
                addSnapshot(s, 'score'); 
                saveNewState(s); 
            }
        }
        
        function handlePitchEvent(type) { 
            let s = JSON.parse(JSON.stringify(window.gameState)); 
            const pName = s.currentPitcher[s.half==='top'?'home':'visitor']; 
            s.count.balls++; addPitcherCount(s, pName, 'ball'); 
            const res = advanceRunners(s, 1); const r = res.runs; 
            const team = s.half === 'top' ? 'visitor' : 'home'; 
            if (r > 0) { 
                s.score[team].R += r; 
                s.score[team].innings[s.inning] = (s.score[team].innings[s.inning]||0) + r; 
                triggerScoreAnim(r); 
                addSnapshot(s, 'score'); 
            } 
            const isER = type === 'WP' ? r : 0; updatePitchingStats(s, pName, type, r, isER); 
            
            const desc = type === 'WP' ? 'âš¾ æš´æŠ•' : 'âš¾ æ•é€¸';
            const logText = generateCommentary('default', type, null, desc);
            s.eventLog.push({ time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: logText }); 
            
            if (s.count.balls >= 4) { handlePlayLogic(s, 'BB', 'å››å£ä¿é€', 0, 0, 0, true); } else { saveNewState(s); } 
        }
        
        function handleBalk() { 
            let s = JSON.parse(JSON.stringify(window.gameState)); 
            const pName = s.currentPitcher[s.half==='top'?'home':'visitor']; 
            const res = advanceRunners(s, 1); const r = res.runs; 
            const team = s.half === 'top' ? 'visitor' : 'home'; 
            if (r > 0) { 
                s.score[team].R += r; 
                s.score[team].innings[s.inning] = (s.score[team].innings[s.inning]||0) + r; 
                triggerScoreAnim(r); 
                addSnapshot(s, 'score'); 
            } 
            updatePitchingStats(s, pName, 'BALK', r, r); 
            
            const logText = generateCommentary('default', 'BALK', null, 'âš ï¸ æŠ•æ‰‹çŠ¯è¦');
            s.eventLog.push({time: new Date().toLocaleTimeString('zh-TW').slice(0,5), text: logText}); 
            saveNewState(s); 
        }

        function addRosterRow() { const s = JSON.parse(JSON.stringify(window.gameState)); const type = document.getElementById('roster-team-select').value; if (window.activeRosterTab === 'batters') s.rosters[type].push({ name: '', number: '', pos: '' }); else s.pitchers[type].push({ name: '', number: '' }); saveNewState(s, false); }
        
        function handleCount(t) { 
            let s = JSON.parse(JSON.stringify(window.gameState)); 
            const p = s.currentPitcher[s.half==='top'?'home':'visitor']; 
            if(t==='ball') { 
                s.count.balls++; addPitcherCount(s,p,'ball'); 
                if(s.count.balls>=4) handlePlayLogic(s,'BB','å››å£ä¿é€',0,0,0,true); else saveNewState(s); 
            } else if(t==='strike') { 
                s.count.strikes++; addPitcherCount(s,p,'strike'); 
                if(s.count.strikes>=3) handlePlayLogic(s,'K','ä¸‰æŒ¯å‡ºå±€',0,0,1,true); else saveNewState(s); 
            } else if(t==='foul') { 
                if(s.count.strikes<2) s.count.strikes++; addPitcherCount(s,p,'foul'); saveNewState(s); 
            } 
        }

        function resetGame() { 
            createConfirmModal('ç¢ºå®šè¦é‡è¨­æ¯”è³½å—ï¼Ÿæ‰€æœ‰ç´€éŒ„å°‡è¢«æ¸…ç©ºã€‚', () => {
                let s=JSON.parse(JSON.stringify(initialState)); 
                s.rosters=window.gameState.rosters; 
                s.pitchers=window.gameState.pitchers; 
                // removed s.commentaryStyle preservation
                saveNewState(s); 
            });
        }

        function updateUI(s) {
            if(!s) return;
            window.gameState = s;
            updateUndoButton(); 
            
            // Removed Style Select update

            const statsSelect = document.getElementById('stats-team-select');
            if (statsSelect) {
                statsSelect.options[0].text = `${s.visitorTeamName} (Visitor)`;
                statsSelect.options[1].text = `${s.homeTeamName} (Home)`;
            }

            document.getElementById('game-date-display').textContent = s.gameDate;
            document.getElementById('game-location-display').textContent = s.gameLocation;
            
            const tbody = document.getElementById('scorecard-body');
            const thead = document.querySelector('#scoreboard-table thead tr');
            let th = `<th class="sticky-corner text-left min-w-[80px]">éšŠä¼</th>`;
            for(let i=1; i<=Math.max(9, s.inning); i++) {
                const activeClass = (i === s.inning) ? 'current-inning-header' : '';
                th += `<th class="sb-th ${activeClass}">${i}</th>`;
            }
            th += `<th class="sb-th th-total col-R text-red-400">R</th><th class="sb-th th-total col-H text-green-400">H</th><th class="sb-th th-total col-E text-yellow-400">E</th>`;
            thead.innerHTML = th;
            
            tbody.innerHTML = ['visitor','home'].map(t => {
                let r = `<tr><td class="sticky-team-col border-b border-slate-700">${t==='visitor'?s.visitorTeamName:s.homeTeamName}</td>`;
                for(let i=1; i<=Math.max(9, s.inning); i++) {
                    const activeClass = (i === s.inning) ? 'current-inning-cell' : '';
                    const score = s.score[t].innings[i];
                    let displayScore = (score !== undefined) ? score : '';
                    if (i > s.inning) displayScore = ''; 
                    if (i === s.inning && score === undefined) displayScore = '0';
                    if (i === s.inning && s.half === 'top' && t === 'home') displayScore = '';
                    const scoreClass = (displayScore !== '' && displayScore > 0) ? 'text-white font-black' : 'text-slate-400';
                    r += `<td class="sb-td ${activeClass} ${scoreClass}">${displayScore}</td>`;
                }
                r += `<td class="sb-td td-total col-R text-red-400">${s.score[t].R}</td>
                      <td class="sb-td td-total col-H text-green-400">${s.score[t].H}</td>
                      <td class="sb-td td-total col-E text-yellow-400">${s.score[t].E}</td></tr>`;
                return r;
            }).join('');

            document.getElementById('inning-num-display').innerText = s.inning;
            document.getElementById('inning-arrow-display').innerText = s.half === 'top' ? 'â–²' : 'â–¼';
            document.getElementById('inning-arrow-display').className = `text-2xl ml-2 drop-shadow-md ${s.half === 'top' ? 'text-yellow-500' : 'text-yellow-500'}`;

            [1,2,3].forEach(i => { const el = document.getElementById(`ball-${i}`); if(s.count.balls >= i) el.classList.add('ball-on'); else el.classList.remove('ball-on'); });
            [1,2].forEach(i => { const el = document.getElementById(`strike-${i}`); if(s.count.strikes >= i) el.classList.add('strike-on'); else el.classList.remove('strike-on'); });
            [1,2].forEach(i => { const el = document.getElementById(`out-${i}`); if(s.count.outs >= i) el.classList.add('out-on'); else el.classList.remove('out-on'); });

            ['1B','2B','3B'].forEach(k => {
                const baseId = `base${k[0]}`;
                const el = document.getElementById(baseId); 
                if(el) {
                    const textEl = document.getElementById(`text-base-${k}`);
                    if (s.runners[k]) { el.classList.add('base-occupied'); const name = s.runnerNames[k]; const num = getPlayerNumber(name); textEl.textContent = num; } 
                    else { el.classList.remove('base-occupied'); textEl.textContent = ''; }
                }
            });
            
            const bt = s.half==='top'?'visitor':'home'; const pt = s.half==='top'?'home':'visitor';
            const batter = s.rosters[bt][s.currentBatterIdx[bt]]; const pitcherName = s.currentPitcher[pt];
            document.getElementById('display-batter-name').textContent = batter ? `${batter.number?`#${batter.number}`:''} ${batter.name}` : 'Unknown';
            document.getElementById('display-pitcher-name').textContent = pitcherName;
            
            const bStat = getPlayerStat(s, batter.name); document.getElementById('batter-today-stats-full').textContent = `${bStat.h}-${bStat.ab} | ${bStat.hr}HR`;
            const pStat = getPlayerStat(s, pitcherName); const currentNP = pStat ? pStat.np : 0; const stamina = Math.max(0, 100 - currentNP);
            
            document.getElementById('pitch-count-val').innerText = currentNP;
            const bar = document.getElementById('pitch-count-bar');
            bar.style.width = `${stamina}%`;
            if(stamina > 50) bar.className = 'h-full bg-green-400 transition-all duration-500';
            else if(stamina > 20) bar.className = 'h-full bg-yellow-400 transition-all duration-500';
            else bar.className = 'h-full bg-red-500 transition-all duration-500';

            const logEl = document.getElementById('event-log');
            logEl.innerHTML = s.eventLog.slice().reverse().map(l => `<div class="p-2 border-b border-slate-700 last:border-0"><span class="text-blue-400 font-bold mr-2">${l.time}</span>${l.text}</div>`).join('');

            if(s.gameOver) {
                document.getElementById('game-over-display').classList.remove('hidden');
                document.getElementById('game-decisions-container').innerHTML = calculateDecisions(s);
            } else {
                document.getElementById('game-over-display').classList.add('hidden');
            }

            renderStatsTables(s); 
            // renderRosterInputs(s); // Called locally, not via window.
            // But wait, we need to call it to update the roster tab if it's visible.
            // Let's check if the roster tab is active.
            if (document.getElementById('tab-roster').classList.contains('hidden') === false) {
                renderRosterInputs(s);
            }
        }

        // --- 8. GLOBAL EVENT DELEGATION (SETUP) ---
        function setupGlobalDelegation() {
            let timer = null;
            let isLong = false;
            let targetEl = null;

            const start = (e) => {
                const el = e.target.closest('[data-long-press]');
                if (!el) return;
                if (e.type === 'mousedown' && e.button !== 0) return;
                targetEl = el;
                isLong = false;
                targetEl.classList.add('pressing');
                timer = setTimeout(() => {
                    if (targetEl) {
                        isLong = true;
                        if (navigator.vibrate) navigator.vibrate(50);
                        handleLongPressAction(targetEl.dataset.longPress);
                        targetEl.classList.remove('pressing');
                        targetEl = null; 
                    }
                }, 500);
            };

            const end = (e) => {
                if (!targetEl) return;
                clearTimeout(timer);
                targetEl.classList.remove('pressing');
                if (!isLong) {
                    e.preventDefault(); 
                    handleShortPressAction(targetEl.dataset.longPress);
                } else {
                    e.preventDefault(); 
                }
                targetEl = null;
                isLong = false;
            };

            const cancel = () => {
                if (targetEl) {
                    clearTimeout(timer);
                    targetEl.classList.remove('pressing');
                    targetEl = null;
                    isLong = false;
                }
            };

            document.body.addEventListener('mousedown', start);
            document.body.addEventListener('touchstart', start, {passive: false});
            document.body.addEventListener('mouseup', end);
            document.body.addEventListener('touchend', end);
            document.body.addEventListener('mousemove', (e) => { if (targetEl && !targetEl.contains(e.target)) cancel(); });
            document.body.addEventListener('touchmove', (e) => { if (targetEl) { const touch = e.touches[0]; const elUnder = document.elementFromPoint(touch.clientX, touch.clientY); if (!targetEl.contains(elUnder)) cancel(); } }, {passive: true});
        }

        function handleShortPressAction(actionType) {
            if (actionType === 'hit') handlePlay('1B', 'ä¸€å£˜å®‰æ‰“', 1, 0, 0);
            else if (actionType === 'out') handlePlay('GO', 'æ»¾åœ°å‡ºå±€', 0, 0, 1);
            else if (actionType === 'walk') handlePlay('BB', 'å››å£ä¿é€', 0, 0, 0, true);
            else if (actionType === 'special') handlePlay('E', 'å®ˆå‚™å¤±èª¤', 0, 1, 0);
            else if (actionType.startsWith('base')) { const base = actionType.replace('base', ''); handleBaseClick(base); }
        }

        function handleLongPressAction(actionType) {
            if (actionType === 'hit') showHitOptions();
            else if (actionType === 'out') showOutOptions();
            else if (actionType === 'walk') showWalkOptions();
            else if (actionType === 'special') showSpecialOptions();
            else if (actionType.startsWith('base')) { const base = actionType.replace('base', ''); showBaseOptions(base); }
        }
        
        setupGlobalDelegation();

        // --- 9. INITIALIZATION & LISTENERS ---
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); setLogLevel('silent');
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; if(unsubscribe) unsubscribe(); setupFirestoreListener(); } 
                    else { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); }
                });
            } catch (e) { console.error("Firebase Init Error:", e); }
        }

        function setupFirestoreListener() {
            if (!db || !userId) return;
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/baseball_scorecards_pro/game_state`);
            getDoc(docRef).then((snap) => {
                if (!snap.exists()) { saveNewState(initialState); } 
                else {
                    const data = snap.data();
                    let migrated = false;
                    if (data.rosters && data.rosters.visitor.length < 12) { const diff = 12 - data.rosters.visitor.length; for(let i=0; i<diff; i++) data.rosters.visitor.push({name:'', number:'', pos:''}); migrated = true; }
                    if (data.rosters && data.rosters.home.length < 12) { const diff = 12 - data.rosters.home.length; for(let i=0; i<diff; i++) data.rosters.home.push({name:'', number:'', pos:''}); migrated = true; }
                    if (data.pitchers && data.pitchers.visitor.length < 6) { const diff = 6 - data.pitchers.visitor.length; for(let i=0; i<diff; i++) data.pitchers.visitor.push({name:'', number:''}); migrated = true; }
                    if (data.pitchers && data.pitchers.home.length < 6) { const diff = 6 - data.pitchers.home.length; for(let i=0; i<diff; i++) data.pitchers.home.push({name:'', number:''}); migrated = true; }
                    if (!data.gameSnapshots) { data.gameSnapshots = []; migrated = true; }
                    // removed commentaryStyle migration
                    if (migrated) saveNewState(data); else updateUI(data);
                }
            });
            unsubscribe = onSnapshot(docRef, (snap) => { if (snap.exists()) updateUI(snap.data()); });
        }

        // --- 10. WINDOW ASSIGNMENTS (EXPOSE TO GLOBAL) ---
        window.editGameDate = editGameDate;
        window.editGameLocation = editGameLocation;
        window.showTab = showTab;
        window.switchStatsTeam = switchStatsTeam;
        window.switchStatsType = switchStatsType;
        window.switchRosterTab = switchRosterTab;
        // removed changeCommentaryStyle binding
        window.createOptionModal = createOptionModal;
        window.showHelpModal = showHelpModal;
        window.showToast = showToast;
        window.undoLastAction = undoLastAction;
        window.resetGame = resetGame;
        window.handleCount = handleCount;
        window.handlePlay = handlePlay;
        window.handleOptionClick = handleOptionClick;
        window.handleBaseClick = handleBaseClick;
        window.updateTeamName = updateTeamName;
        window.updateRosterPlayer = updateRosterPlayer;
        window.updateRosterPitcher = updateRosterPitcher;
        window.addRosterRow = addRosterRow;
        window.renderRosterInputs = renderRosterInputs;
        window.showBaseOptions = showBaseOptions;
        window.showHitOptions = showHitOptions;
        window.showOutOptions = showOutOptions;
        window.showWalkOptions = showWalkOptions;
        window.showSpecialOptions = showSpecialOptions;
        window.nextHalfInning = nextHalfInning;
        window.initializeFirebase = initializeFirebase;
        
        window.onload = initializeFirebase;

    </script>
</body>
</html>
